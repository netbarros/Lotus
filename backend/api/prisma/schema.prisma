// MagicSaaS System-∞ Database Schema
// Generated by: Sofia Lotus AI - PhD Full-Stack Engineer
// Version: ∞.2026.Q1

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions", "fullTextSearch", "views"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [pgvector(map: "vector", schema: "public"), timescaledb]
}

// ============================================================================
// TENANT & MULTI-TENANCY
// ============================================================================

model Tenant {
  id        String   @id @default(uuid())
  name      String
  slug      String   @unique
  domain    String?  @unique
  plan_id   String
  status    TenantStatus @default(TRIAL)
  branding  Json     // {logo_url, primary_color, secondary_color, custom_css}
  features  String[]
  limits    Json     // {max_users, max_storage_gb, api_rate_limit}
  metadata  Json?
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  // Relations
  plan             Plan               @relation(fields: [plan_id], references: [id])
  users            User[]
  roles            Role[]
  credit_wallet    CreditWallet?
  usage_records    UsageRecord[]
  workflows        Workflow[]
  voice_sessions   VoiceSession[]
  plugins          PluginInstallation[]
  federated_participants FederatedParticipant[]
  quantum_jobs     QuantumJob[]
  audit_logs       AuditLog[]

  @@index([slug])
  @@index([domain])
  @@index([status])
  @@map("tenants")
}

enum TenantStatus {
  ACTIVE
  TRIAL
  SUSPENDED
  CHURNED
}

// ============================================================================
// USERS & AUTHENTICATION
// ============================================================================

model User {
  id              String    @id @default(uuid())
  tenant_id       String
  email           String
  password_hash   String
  full_name       String
  avatar_url      String?
  role_id         String
  permissions     String[]
  twofa_enabled   Boolean   @default(false)
  twofa_secret    String?
  last_login_at   DateTime?
  login_count     Int       @default(0)
  preferences     Json      @default("{}")
  metadata        Json?
  created_at      DateTime  @default(now())
  updated_at      DateTime  @updatedAt

  // Relations
  tenant          Tenant    @relation(fields: [tenant_id], references: [id], onDelete: Cascade)
  role            Role      @relation(fields: [role_id], references: [id])
  voice_sessions  VoiceSession[]
  voice_contexts  VoiceContext[]
  quantum_jobs    QuantumJob[]
  audit_logs      AuditLog[]

  @@unique([tenant_id, email])
  @@index([email])
  @@index([tenant_id])
  @@map("users")
}

model Role {
  id          String   @id @default(uuid())
  tenant_id   String?  // null = global system role
  name        String
  description String?
  permissions Json     // Permission[]
  is_system   Boolean  @default(false)
  created_at  DateTime @default(now())

  // Relations
  tenant      Tenant?  @relation(fields: [tenant_id], references: [id], onDelete: Cascade)
  users       User[]

  @@unique([tenant_id, name])
  @@map("roles")
}

// ============================================================================
// BILLING & CREDITS (LOTUS CREDITS)
// ============================================================================

model Plan {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  tier        PlanTier
  pricing     Json     // {monthly_usd, annual_usd, currency}
  limits      Json     // {seats, ai_tokens_monthly, voice_minutes_monthly, ...}
  features    String[]
  is_active   Boolean  @default(true)
  created_at  DateTime @default(now())

  // Relations
  tenants     Tenant[]

  @@map("plans")
}

enum PlanTier {
  FREE
  STARTER
  PROFESSIONAL
  ENTERPRISE
  QUANTUM
}

model CreditWallet {
  id                      String   @id @default(uuid())
  tenant_id               String   @unique
  balance                 Float    @default(0)
  currency                String   @default("LOTUS_CREDITS")
  reserved                Float    @default(0)
  lifetime_earned         Float    @default(0)
  lifetime_spent          Float    @default(0)
  last_recharge_at        DateTime?
  auto_recharge_enabled   Boolean  @default(false)
  auto_recharge_threshold Float    @default(10)
  auto_recharge_amount    Float    @default(100)
  created_at              DateTime @default(now())
  updated_at              DateTime @updatedAt

  // Relations
  tenant                  Tenant   @relation(fields: [tenant_id], references: [id], onDelete: Cascade)
  transactions            CreditTransaction[]

  @@map("credit_wallets")
}

model CreditTransaction {
  id          String   @id @default(uuid())
  wallet_id   String
  amount      Float
  type        TransactionType
  category    TransactionCategory
  description String
  reference_id String? // link to usage_record, payment, etc.
  metadata    Json?
  created_at  DateTime @default(now())

  // Relations
  wallet      CreditWallet @relation(fields: [wallet_id], references: [id], onDelete: Cascade)

  @@index([wallet_id])
  @@index([created_at])
  @@map("credit_transactions")
}

enum TransactionType {
  CREDIT
  DEBIT
  REFUND
  BONUS
}

enum TransactionCategory {
  AI_USAGE
  VOICE
  EDGE
  BLOCKCHAIN
  QUANTUM
  RECHARGE
  SUBSCRIPTION
  REFERRAL
}

model UsageRecord {
  id            String   @id @default(uuid())
  tenant_id     String
  user_id       String?
  service_type  ServiceType
  provider      String?
  quantity      Float
  unit          String
  cost_credits  Float
  metadata      Json?
  created_at    DateTime @default(now())

  // Relations
  tenant        Tenant   @relation(fields: [tenant_id], references: [id], onDelete: Cascade)

  @@index([tenant_id])
  @@index([service_type])
  @@index([created_at])
  @@map("usage_records")
}

enum ServiceType {
  LLM
  VOICE_TTS
  VOICE_STT
  OCR
  EDGE_COMPUTE
  BLOCKCHAIN_TX
  QUANTUM_JOB
}

// ============================================================================
// WORKFLOWS & AUTOMATION (INNGEST)
// ============================================================================

model Workflow {
  id                String   @id @default(uuid())
  tenant_id         String
  name              String
  description       String?
  trigger           Json     // {type, config}
  steps             Json     // WorkflowStep[]
  status            WorkflowStatus @default(DRAFT)
  execution_count   Int      @default(0)
  last_executed_at  DateTime?
  metadata          Json?
  created_at        DateTime @default(now())
  updated_at        DateTime @updatedAt

  // Relations
  tenant            Tenant   @relation(fields: [tenant_id], references: [id], onDelete: Cascade)
  executions        WorkflowExecution[]

  @@index([tenant_id])
  @@index([status])
  @@map("workflows")
}

enum WorkflowStatus {
  ACTIVE
  PAUSED
  DRAFT
}

model WorkflowExecution {
  id            String   @id @default(uuid())
  workflow_id   String
  status        ExecutionStatus
  input         Json?
  output        Json?
  error         String?
  started_at    DateTime @default(now())
  completed_at  DateTime?
  duration_ms   Int?

  // Relations
  workflow      Workflow @relation(fields: [workflow_id], references: [id], onDelete: Cascade)

  @@index([workflow_id])
  @@index([status])
  @@index([started_at])
  @@map("workflow_executions")
}

enum ExecutionStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
  CANCELLED
}

// ============================================================================
// AI & VOICE SERVICES
// ============================================================================

model AIProvider {
  id            String   @id @default(uuid())
  name          String   @unique
  type          AIProviderType
  provider      String
  config        Json
  cost_per_unit Float
  is_active     Boolean  @default(true)
  created_at    DateTime @default(now())

  @@map("ai_providers")
}

enum AIProviderType {
  LLM
  VISION
  EMBEDDING
  VOICE
}

model VoiceSession {
  id              String   @id @default(uuid())
  tenant_id       String
  user_id         String
  session_type    VoiceSessionType
  language        String
  features        String[]
  context_data    Json?
  duration_seconds Float   @default(0)
  tokens_used     Int      @default(0)
  cost_credits    Float    @default(0)
  metadata        Json?
  started_at      DateTime @default(now())
  ended_at        DateTime?

  // Relations
  tenant          Tenant   @relation(fields: [tenant_id], references: [id], onDelete: Cascade)
  user            User     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([tenant_id])
  @@index([user_id])
  @@index([started_at])
  @@map("voice_sessions")
}

enum VoiceSessionType {
  INTERACTIVE
  BATCH
  STREAMING
}

model VoiceContext {
  id                    String   @id @default(uuid())
  user_id               String   @unique
  context_data          Json     @default("{}")
  personality_profile   Json     @default("{}")
  interaction_history   Json     @default("[]")
  preferences           Json     @default("{}")
  last_interaction_at   DateTime?
  created_at            DateTime @default(now())
  updated_at            DateTime @updatedAt

  // Relations
  user                  User     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@map("voice_contexts")
}

// ============================================================================
// BLOCKCHAIN & MARKETPLACE
// ============================================================================

model MarketplacePlugin {
  id              String   @id @default(uuid())
  name            String
  slug            String   @unique
  description     String
  category        String
  creator_id      String
  ipfs_hash       String
  blockchain_tx_hash String?
  nft_token_id    String?
  price_usd       Float
  price_crypto    Json?    // {amount, currency}
  royalty_percentage Float @default(0)
  verified        Boolean  @default(false)
  total_sales     Int      @default(0)
  rating_avg      Float    @default(0)
  rating_count    Int      @default(0)
  installs_count  Int      @default(0)
  metadata        Json?
  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt

  // Relations
  purchases       PluginPurchase[]
  installations   PluginInstallation[]

  @@index([slug])
  @@index([category])
  @@index([verified])
  @@map("marketplace_plugins")
}

model PluginPurchase {
  id                String   @id @default(uuid())
  plugin_id         String
  buyer_tenant_id   String
  buyer_user_id     String?
  amount_paid_usd   Float
  amount_paid_crypto Json?
  blockchain_tx_hash String?
  license_key       String   @unique
  status            PurchaseStatus @default(PENDING)
  purchased_at      DateTime @default(now())

  // Relations
  plugin            MarketplacePlugin @relation(fields: [plugin_id], references: [id])

  @@index([plugin_id])
  @@index([buyer_tenant_id])
  @@index([license_key])
  @@map("plugin_purchases")
}

enum PurchaseStatus {
  PENDING
  COMPLETED
  REFUNDED
}

model PluginInstallation {
  id          String   @id @default(uuid())
  plugin_id   String
  tenant_id   String
  version     String
  status      InstallationStatus @default(ACTIVE)
  config      Json?
  installed_at DateTime @default(now())
  updated_at  DateTime @updatedAt

  // Relations
  plugin      MarketplacePlugin @relation(fields: [plugin_id], references: [id])
  tenant      Tenant   @relation(fields: [tenant_id], references: [id], onDelete: Cascade)

  @@unique([plugin_id, tenant_id])
  @@index([tenant_id])
  @@map("plugin_installations")
}

enum InstallationStatus {
  ACTIVE
  INACTIVE
  ERROR
}

// ============================================================================
// FEDERATED LEARNING
// ============================================================================

model FederatedModel {
  id                String   @id @default(uuid())
  name              String
  description       String?
  model_type        ModelType
  base_model_version String
  current_round     Int      @default(0)
  total_rounds      Int
  min_participants  Int
  privacy_level     PrivacyLevel
  status            FederatedModelStatus @default(INITIALIZING)
  metadata          Json?
  created_at        DateTime @default(now())
  updated_at        DateTime @updatedAt

  // Relations
  participants      FederatedParticipant[]

  @@map("federated_models")
}

enum ModelType {
  CLASSIFICATION
  REGRESSION
  NLP
  VISION
}

enum PrivacyLevel {
  DIFFERENTIAL
  SECURE_AGGREGATION
  HOMOMORPHIC
}

enum FederatedModelStatus {
  INITIALIZING
  TRAINING
  AGGREGATING
  COMPLETED
}

model FederatedParticipant {
  id                    String   @id @default(uuid())
  model_id              String
  tenant_id             String
  status                ParticipantStatus @default(ENROLLED)
  contribution_count    Int      @default(0)
  last_contribution_at  DateTime?
  rewards_earned        Float    @default(0)
  metadata              Json?
  joined_at             DateTime @default(now())

  // Relations
  model                 FederatedModel @relation(fields: [model_id], references: [id], onDelete: Cascade)
  tenant                Tenant   @relation(fields: [tenant_id], references: [id], onDelete: Cascade)

  @@unique([model_id, tenant_id])
  @@index([model_id])
  @@map("federated_participants")
}

enum ParticipantStatus {
  ENROLLED
  TRAINING
  SUBMITTED
  DROPPED
}

// ============================================================================
// QUANTUM COMPUTING
// ============================================================================

model QuantumJob {
  id                String   @id @default(uuid())
  tenant_id         String
  user_id           String
  job_type          QuantumJobType
  algorithm         String
  backend           String
  input_data        Json
  output_data       Json?
  status            QuantumJobStatus @default(QUEUED)
  cost_credits      Float
  execution_time_ms Int?
  quantum_advantage Float?   // speedup vs classical
  error_rate        Float?
  submitted_at      DateTime @default(now())
  completed_at      DateTime?

  // Relations
  tenant            Tenant   @relation(fields: [tenant_id], references: [id], onDelete: Cascade)
  user              User     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([tenant_id])
  @@index([user_id])
  @@index([status])
  @@map("quantum_jobs")
}

enum QuantumJobType {
  OPTIMIZATION
  SIMULATION
  ML
  CRYPTOGRAPHY
}

enum QuantumJobStatus {
  QUEUED
  RUNNING
  COMPLETED
  FAILED
}

// ============================================================================
// AUDIT & COMPLIANCE
// ============================================================================

model AuditLog {
  id            String   @id @default(uuid())
  tenant_id     String
  user_id       String?
  action        String
  resource_type String
  resource_id   String?
  changes       Json?
  ip_address    String
  user_agent    String
  status        AuditStatus
  metadata      Json?
  created_at    DateTime @default(now())

  // Relations
  tenant        Tenant   @relation(fields: [tenant_id], references: [id], onDelete: Cascade)
  user          User?    @relation(fields: [user_id], references: [id], onDelete: SetNull)

  @@index([tenant_id])
  @@index([user_id])
  @@index([action])
  @@index([created_at])
  @@map("audit_logs")
}

enum AuditStatus {
  SUCCESS
  FAILURE
}

// ============================================================================
// SYSTEM CONFIGURATION
// ============================================================================

model SystemConfig {
  id          String   @id @default(uuid())
  key         String   @unique
  value       Json
  description String?
  is_public   Boolean  @default(false)
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  @@map("system_config")
}
